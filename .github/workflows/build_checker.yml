name: Build Checker CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches-ignore: [ga-ignore-**, gh-pages]
    paths:
      - '**.cpp'
      - '**.hpp'
      - '**.c'
      - '**.h'
      - '**.in'
      - '**.inl'
      - '**.txt'
      - '**.lua'
      - '**/build_checker.yml'

jobs:
  build_checker:
    name: Build Checker
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        target: [flakkari-server, flakkari-client]
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v5

      - name: Cache xmake and downloaded packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.xmake
            ~/.xmake/cache
            ~/.xmake/packages
            .xmake-cache
          key: ${{ runner.os }}-xmake-${{ hashFiles('xmake.lua') }}
          restore-keys: |
            ${{ runner.os }}-xmake-

      - name: Install xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest
          actions-cache-folder: '.xmake-cache'
          actions-cache-key: '${{ runner.os }}-xmake-install'
          package-cache: true
          package-cache-key: "${{ runner.os }}-xmake-${{ hashFiles('xmake.lua') }}"
          project-path: '.'

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config ca-certificates git curl
          sudo apt-get install -y libgl1-mesa-dev libglu1-mesa-dev libfreetype6-dev \
            libx11-dev libxrandr-dev libxinerama-dev libxi-dev libxext-dev libxfixes-dev libxcb1-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install pkg-config freetype glew

      - name: Configure
        run: |
          xmake config -y

      - name: Build ${{ matrix.target }}
        run: |
          xmake build ${{ matrix.target }}
        timeout-minutes: 6
