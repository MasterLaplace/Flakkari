name: Debug Windows Build Environment

on:
  push:
    branches:
      - 95-bug-ci-build-and-upload-artifacts-failed-for-windows
  workflow_dispatch:

jobs:
  debug_windows_environment:
    name: Debug Windows Build Environment
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: 1Ô∏è‚É£ System Information
        shell: pwsh
        run: |
          Write-Host "==================== SYSTEM INFO ====================" -ForegroundColor Cyan
          Write-Host "OS Version:" -ForegroundColor Yellow
          Get-ComputerInfo | Select-Object WindowsProductName, WindowsVersion, OsHardwareAbstractionLayer

          Write-Host "`nProcessor:" -ForegroundColor Yellow
          Get-CimInstance -ClassName Win32_Processor | Select-Object Name, NumberOfCores, NumberOfLogicalProcessors

          Write-Host "`nArchitecture:" -ForegroundColor Yellow
          Write-Host $env:PROCESSOR_ARCHITECTURE

          Write-Host "`nAvailable RAM:" -ForegroundColor Yellow
          $ram = Get-CimInstance Win32_PhysicalMemory | Measure-Object -Property capacity -Sum
          Write-Host "$([math]::round($ram.sum / 1GB, 2)) GB"

      - name: 2Ô∏è‚É£ Check Visual Studio Installation
        shell: pwsh
        run: |
          Write-Host "==================== VISUAL STUDIO ====================" -ForegroundColor Cyan
          Write-Host "`nSearching for Visual Studio installations..." -ForegroundColor Yellow

          # Check vswhere
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (Test-Path $vswhere) {
            Write-Host "`nvswhere found at: $vswhere" -ForegroundColor Green
            & $vswhere -all
          } else {
            Write-Host "`nvswhere NOT FOUND" -ForegroundColor Red
          }

          # Check common VS paths
          Write-Host "`nChecking common VS paths..." -ForegroundColor Yellow
          $vsPaths = @(
            "${env:ProgramFiles}\Microsoft Visual Studio\2022",
            "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022",
            "${env:ProgramFiles}\Microsoft Visual Studio\2019",
            "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2019"
          )
          foreach ($path in $vsPaths) {
            if (Test-Path $path) {
              Write-Host "‚úì Found: $path" -ForegroundColor Green
              Get-ChildItem $path -Directory | Select-Object Name
            } else {
              Write-Host "‚úó Not found: $path" -ForegroundColor Red
            }
          }

      - name: 3Ô∏è‚É£ Check MSVC Compiler
        shell: pwsh
        run: |
          Write-Host "==================== MSVC COMPILER ====================" -ForegroundColor Cyan

          # Try to find cl.exe
          Write-Host "`nSearching for cl.exe..." -ForegroundColor Yellow
          Get-ChildItem -Path "C:\Program Files" -Filter "cl.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName

          # Check environment variables
          Write-Host "`nRelevant Environment Variables:" -ForegroundColor Yellow
          Get-ChildItem Env: | Where-Object { $_.Name -like "*VS*" -or $_.Name -like "*MSVC*" } | Format-Table Name, Value -AutoSize

      - name: 4Ô∏è‚É£ Check Available Compilers
        shell: pwsh
        run: |
          Write-Host "==================== AVAILABLE COMPILERS ====================" -ForegroundColor Cyan

          Write-Host "`nChecking for gcc/g++..." -ForegroundColor Yellow
          try {
            gcc --version
            Write-Host "‚úì gcc found" -ForegroundColor Green
          } catch {
            Write-Host "‚úó gcc not found" -ForegroundColor Red
          }

          Write-Host "`nChecking for clang..." -ForegroundColor Yellow
          try {
            clang --version
            Write-Host "‚úì clang found" -ForegroundColor Green
          } catch {
            Write-Host "‚úó clang not found" -ForegroundColor Red
          }

          Write-Host "`nChecking PATH for compilers..." -ForegroundColor Yellow
          $env:PATH -split ';' | Where-Object { $_ -match 'Visual Studio|MSVC|mingw|gcc|clang' }

      - name: 5Ô∏è‚É£ Install xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest
          actions-cache-folder: '.xmake-cache'
          actions-cache-key: 'debug-${{ runner.os }}-xmake-install'
          package-cache: true
          package-cache-key: 'debug-${{ runner.os }}-xmake-packages'
          project-path: '.'

      - name: 6Ô∏è‚É£ XMake Detection (before config)
        shell: pwsh
        run: |
          Write-Host "==================== XMAKE DETECTION ====================" -ForegroundColor Cyan

          Write-Host "`nXMake version:" -ForegroundColor Yellow
          xmake --version

          Write-Host "`nXMake global config:" -ForegroundColor Yellow
          xmake g --show

          Write-Host "`nAvailable toolchains:" -ForegroundColor Yellow
          xmake show -l toolchains

      - name: 7Ô∏è‚É£ XMake Config with Verbose Output
        shell: pwsh
        run: |
          Write-Host "==================== XMAKE CONFIG ====================" -ForegroundColor Cyan
          Write-Host "`nConfiguring with verbose output..." -ForegroundColor Yellow
          xmake f -y -m release -v --diagnosis

      - name: 8Ô∏è‚É£ XMake Config Details
        shell: pwsh
        run: |
          Write-Host "==================== CONFIG DETAILS ====================" -ForegroundColor Cyan

          Write-Host "`nProject configuration:" -ForegroundColor Yellow
          xmake f --show

          Write-Host "`nDetected compiler:" -ForegroundColor Yellow
          xmake l -c "import('core.tool.toolchain'); local tc = toolchain.load('msvc'); if tc then print('MSVC found: ' .. (tc:check() and 'YES' or 'NO')); for k,v in pairs(tc:config()) do print(k .. ' = ' .. tostring(v)) end else print('MSVC toolchain not found') end"

      - name: 9Ô∏è‚É£ Try Building a Simple Target
        shell: pwsh
        run: |
          Write-Host "==================== BUILD TEST ====================" -ForegroundColor Cyan
          Write-Host "`nAttempting to build flakkari-client..." -ForegroundColor Yellow
          xmake build flakkari-client -v

      - name: üîü Check Package Requirements
        shell: pwsh
        run: |
          Write-Host "==================== PACKAGE REQUIREMENTS ====================" -ForegroundColor Cyan
          Write-Host "`nChecking required packages..." -ForegroundColor Yellow
          xmake require --list

          Write-Host "`nPackage installation directory:" -ForegroundColor Yellow
          xmake l -c "import('core.package.package'); print(package.installdir())"

      - name: 1Ô∏è‚É£1Ô∏è‚É£ Try Pack Command with Verbose
        shell: pwsh
        run: |
          Write-Host "==================== PACK COMMAND ====================" -ForegroundColor Cyan
          Write-Host "`nAttempting xmake pack..." -ForegroundColor Yellow
          xmake f -y -m release --pack-server=n --pack-client=y -v
          xmake pack -y -v --diagnosis

      - name: 1Ô∏è‚É£2Ô∏è‚É£ Summary and Diagnostics
        if: always()
        shell: pwsh
        run: |
          Write-Host "==================== SUMMARY ====================" -ForegroundColor Cyan
          Write-Host "`nBuild directory contents:" -ForegroundColor Yellow
          if (Test-Path "build") {
            Get-ChildItem -Path "build" -Recurse | Select-Object FullName
          } else {
            Write-Host "Build directory not found" -ForegroundColor Red
          }

          Write-Host "`nXMake cache directory:" -ForegroundColor Yellow
          if (Test-Path ".xmake") {
            Get-ChildItem -Path ".xmake" -Recurse -Depth 2 | Select-Object FullName
          } else {
            Write-Host ".xmake directory not found" -ForegroundColor Red
          }

          Write-Host "`nCheck for error logs..." -ForegroundColor Yellow
          Get-ChildItem -Path "." -Filter "*.log" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
