name: Build and Upload Windows Artifacts

on:
  push:
    branches:
      - 95-bug-ci-build-and-upload-artifacts-failed-for-windows
  workflow_dispatch:

jobs:
  build_and_upload_windows:
    name: Build and Upload Windows Artifacts
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Setup xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest
          actions-cache-folder: '.xmake-cache'
          actions-cache-key: 'windows-${{ runner.os }}-xmake-install'
          package-cache: true
          package-cache-key: 'windows-${{ runner.os }}-xmake-packages'
          project-path: '.'

      - name: Configure for Windows Release
        shell: pwsh
        run: |
          Write-Host "Configuring xmake for Windows release build..." -ForegroundColor Cyan
          xmake f -y -m release --pack-server=n --pack-client=y

      - name: Build Client
        shell: pwsh
        run: |
          Write-Host "Building flakkari-client..." -ForegroundColor Cyan
          xmake build flakkari-client

      - name: Pack Client Artifacts
        shell: pwsh
        run: |
          Write-Host "Creating client packages..." -ForegroundColor Cyan
          xmake pack -y

      - name: List Generated Artifacts
        shell: pwsh
        run: |
          Write-Host "==================== GENERATED ARTIFACTS ====================" -ForegroundColor Cyan
          if (Test-Path "build/xpack") {
            Get-ChildItem -Path "build/xpack" -Recurse -File | Select-Object Name, Length, FullName | Format-Table -AutoSize
          } else {
            Write-Host "No artifacts found!" -ForegroundColor Red
            exit 1
          }

      - name: Upload Artifacts to Release v0.9.0
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Uploading artifacts to release v0.9.0..." -ForegroundColor Cyan

          $releaseTag = "v0.9.0"
          $artifacts = Get-ChildItem -Path "build/xpack/flakkari" -File

          # Get release ID
          $release = gh release view $releaseTag --json id,uploadUrl | ConvertFrom-Json

          if (-not $release) {
            Write-Host "Release $releaseTag not found!" -ForegroundColor Red
            exit 1
          }

          Write-Host "Found release: $releaseTag (ID: $($release.id))" -ForegroundColor Green

          # Upload each artifact
          foreach ($artifact in $artifacts) {
            Write-Host "`nUploading: $($artifact.Name) ($([math]::Round($artifact.Length/1KB, 2)) KB)" -ForegroundColor Yellow
            gh release upload $releaseTag $artifact.FullName --clobber

            if ($LASTEXITCODE -eq 0) {
              Write-Host "‚úÖ Successfully uploaded: $($artifact.Name)" -ForegroundColor Green
            } else {
              Write-Host "‚ùå Failed to upload: $($artifact.Name)" -ForegroundColor Red
              exit 1
            }
          }

          Write-Host "`nüéâ All artifacts uploaded successfully!" -ForegroundColor Green
