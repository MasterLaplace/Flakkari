name: Build and Upload Windows Artifacts for v0.9.0

on:
  push:
    branches:
      - 95-bug-ci-build-and-upload-artifacts-failed-for-windows
  workflow_dispatch:

jobs:
  build_and_upload_windows:
    name: Build and Upload ${{ matrix.package-type }} Artifacts
    runs-on: windows-latest
    strategy:
      matrix:
        package-type: [server, client]
    steps:
      - name: Checkout Repository (v0.9.0 tag)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: v0.9.0

      - name: Install xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest
          actions-cache-folder: '.xmake-cache'
          actions-cache-key: '${{ runner.os }}-xmake-install'
          package-cache: true
          package-cache-key: '${{ runner.os }}-xmake-nlohmann_json-libcurl-libgit2'
          project-path: '.'

      - name: Configure package type
        shell: bash
        run: |
          case "${{ matrix.package-type }}" in
            server)
              xmake f -y -m release --pack-server=y --pack-client=n
              ;;
            client)
              xmake f -y -m release --pack-server=n --pack-client=y
              ;;
          esac

      - name: Build Flakkari Package with xpack
        run: xmake pack -y

      - name: Upload ${{ matrix.package-type }} package
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./build/xpack/flakkari/*
          tag_name: v0.9.0
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
