name: Debug Windows Build Environment

on:
  push:
    branches:
      - 95-bug-ci-build-and-upload-artifacts-failed-for-windows
  workflow_dispatch:

jobs:
  debug_windows_environment:
    name: Debug Windows Build Environment
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: 1️⃣ Install xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest
          actions-cache-folder: '.xmake-cache'
          actions-cache-key: 'debug-${{ runner.os }}-xmake-install'
          package-cache: true
          package-cache-key: 'debug-${{ runner.os }}-xmake-packages'
          project-path: '.'

      - name: 2️⃣ XMake Config with Full Diagnosis
        shell: pwsh
        run: |
          Write-Host "==================== XMAKE CONFIG ====================" -ForegroundColor Cyan
          Write-Host "`nConfiguring with full diagnosis..." -ForegroundColor Yellow
          xmake f -y -m release -vD

      - name: 3️⃣ Show Configuration Details
        shell: pwsh
        run: |
          Write-Host "==================== CONFIG DETAILS ====================" -ForegroundColor Cyan

          Write-Host "`nProject configuration:" -ForegroundColor Yellow
          xmake f -p windows

          Write-Host "`n`n==================== MSVC TOOLCHAIN CHECK ====================" -ForegroundColor Cyan
          xmake l -c "import('core.tool.toolchain'); local tc = toolchain.load('msvc'); if tc then print('MSVC toolchain loaded'); print('Check result: ' .. tostring(tc:check())); local cfg = tc:config(); for k,v in pairs(cfg) do print('  ' .. k .. ' = ' .. tostring(v)) end else print('ERROR: MSVC toolchain not found') end"

      - name: 4️⃣ List Required Packages
        shell: pwsh
        run: |
          Write-Host "==================== PACKAGE REQUIREMENTS ====================" -ForegroundColor Cyan
          xmake require --list

      - name: 5️⃣ Try Building Client (should work)
        shell: pwsh
        run: |
          Write-Host "==================== BUILD CLIENT TEST ====================" -ForegroundColor Cyan
          xmake build flakkari-client

      - name: 6️⃣ Configure for Pack (client only)
        shell: pwsh
        run: |
          Write-Host "==================== CONFIGURE FOR PACK ====================" -ForegroundColor Cyan
          xmake f -y -m release --pack-server=n --pack-client=y -vD

      - name: 7️⃣ Try Pack with Full Diagnosis
        shell: pwsh
        run: |
          Write-Host "==================== PACK COMMAND ====================" -ForegroundColor Cyan
          xmake pack -y -vD

      - name: 8️⃣ Check Build Output
        if: always()
        shell: pwsh
        run: |
          Write-Host "==================== BUILD OUTPUT ====================" -ForegroundColor Cyan

          Write-Host "`nbuild/ directory:" -ForegroundColor Yellow
          if (Test-Path "build") {
            Get-ChildItem -Path "build" -Recurse -File | Select-Object FullName, Length | Format-Table -AutoSize
          } else {
            Write-Host "No build directory found" -ForegroundColor Red
          }

          Write-Host "`n`nbuild/xpack/ directory:" -ForegroundColor Yellow
          if (Test-Path "build/xpack") {
            Get-ChildItem -Path "build/xpack" -Recurse | Select-Object FullName
          } else {
            Write-Host "No build/xpack directory found" -ForegroundColor Red
          }

      - name: 9️⃣ Check for Error Logs
        if: always()
        shell: pwsh
        run: |
          Write-Host "==================== ERROR LOGS ====================" -ForegroundColor Cyan

          Write-Host "`nSearching for .log files..." -ForegroundColor Yellow
          $logs = Get-ChildItem -Path "." -Filter "*.log" -Recurse -ErrorAction SilentlyContinue
          if ($logs) {
            foreach ($log in $logs) {
              Write-Host "`n--- $($log.FullName) ---" -ForegroundColor Yellow
              Get-Content $log.FullName -Tail 50
            }
          } else {
            Write-Host "No log files found" -ForegroundColor Green
          }

          Write-Host "`n`nSearching for .xmake logs..." -ForegroundColor Yellow
          if (Test-Path ".xmake") {
            $xmakelogs = Get-ChildItem -Path ".xmake" -Filter "*.log" -Recurse -ErrorAction SilentlyContinue
            if ($xmakelogs) {
              foreach ($log in $xmakelogs) {
                Write-Host "`n--- $($log.FullName) ---" -ForegroundColor Yellow
                Get-Content $log.FullName -Tail 100
              }
            }
          }
